drop database event_management_system;
-- Event Management System Database Schema for MySQL
-- Veritabanı oluşturma
DROP DATABASE IF EXISTS event_management_system;
CREATE DATABASE event_management_system 
CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

USE event_management_system;

-- University tablosu
CREATE TABLE University (
    university_id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(255) NOT NULL,
    short_name_ VARCHAR(100),
    website_url VARCHAR(255)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

USE event_management_system;

INSERT INTO University (name, short_name, website_url) VALUES
('Ankara Üniversitesi', 'AÜ', 'https://www.ankara.edu.tr'),
('Hacettepe Üniversitesi', 'HÜ', 'https://www.hacettepe.edu.tr'),
('Orta Doğu Teknik Üniversitesi', 'ODTÜ', 'https://www.metu.edu.tr');

-- Event tablosu (önce Event, sonra EventDate çünkü FK var)
CREATE TABLE Event (
    event_id INT PRIMARY KEY AUTO_INCREMENT,
    university_id INT,
    title VARCHAR(255) NOT NULL,
    description TEXT,
    category VARCHAR(100), --eklendi
    club VARCHAR(255), --eklendi
    location VARCHAR(255),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by INT,
    is_active BOOLEAN DEFAULT TRUE,
    FOREIGN KEY (university_id) REFERENCES University(university_id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- Ankara Üniversitesi'ndeki "Yapay Zekâ 101" semineri
INSERT INTO Event (university_id, title, description, location, category, club, created_by, is_active)
VALUES (
    1,  -- Ankara Üniversitesi
    'Yapay Zekâ 101',
    'Giriş seviyesinde yapay zekâ ve makine öğrenmesi semineri.',
    'Mühendislik Fakültesi Konferans Salonu',
    'Seminer',
    'Bilgisayar Kulübü',
    NULL,
    TRUE
);

-- Hacettepe Üniversitesi'ndeki "Kampüs Turu" etkinliği
INSERT INTO Event (university_id, title, description, location, category, club, created_by, is_active)
VALUES (
    2,  -- Hacettepe Üniversitesi
    'Kampüs Turu',
    'Yeni gelen öğrenciler için rehberli kampüs turu.',
    'Beytepe Kampüsü',
    'Sosyal',
    'Tanıtım Kulübü',
    NULL,
    TRUE
);



-- EventDate tablosu (HasDate ilişkisi: Event 1:N EventDate)
CREATE TABLE EventDate (
    event_date_id INT PRIMARY KEY AUTO_INCREMENT,
    event_id INT NOT NULL,
    start_datetime DATETIME NOT NULL,
    end_datetime DATETIME NOT NULL,
    FOREIGN KEY (event_id) REFERENCES Event(event_id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- "Yapay Zekâ 101" için (event_id = 1 olduğunu varsayarak)
INSERT INTO EventDate (event_id, start_datetime, end_datetime)
VALUES
(1, '2025-12-10 18:00:00', '2025-12-10 20:00:00');

-- "Kampüs Turu" için (event_id = 2)
INSERT INTO EventDate (event_id, start_datetime, end_datetime)
VALUES
(2, '2025-12-12 14:00:00', '2025-12-12 16:00:00');

-- User tablosu
CREATE TABLE User (
    user_id INT PRIMARY KEY AUTO_INCREMENT,
    role VARCHAR(50) DEFAULT 'user',
    email VARCHAR(255) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_login DATETIME
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- UserProfile tablosu (User ile 1:1 ilişki)
CREATE TABLE UserProfile (
    user_id INT PRIMARY KEY,
    full_name VARCHAR(255) NOT NULL,
    department VARCHAR(255),
    university_id INT,
    class_year INT,
    profile_photo VARCHAR(255),
    bio TEXT,
    FOREIGN KEY (user_id) REFERENCES User(user_id) ON DELETE CASCADE,
    FOREIGN KEY (university_id) REFERENCES University(university_id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- EventAttendance tablosu (User ve Event arasındaki M:N ilişki)
CREATE TABLE EventAttendance (
    user_id INT,
    event_id INT,
    status VARCHAR(50) DEFAULT 'attending',
    like_event BOOLEAN DEFAULT FALSE,
    dislike_event BOOLEAN DEFAULT FALSE,
    marked_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (user_id, event_id),
    FOREIGN KEY (user_id) REFERENCES User(user_id) ON DELETE CASCADE,
    FOREIGN KEY (event_id) REFERENCES Event(event_id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- addEventToFavourite ilişkisi (User favorilerine event ekler)
CREATE TABLE addEventToFavourite (
    user_id INT,
    event_id INT,
    added_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (user_id, event_id),
    FOREIGN KEY (user_id) REFERENCES User(user_id) ON DELETE CASCADE,
    FOREIGN KEY (event_id) REFERENCES Event(event_id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- EventChatMessage tablosu
CREATE TABLE EventChatMessage (
    message_id INT PRIMARY KEY AUTO_INCREMENT,
    event_id INT NOT NULL,
    user_id INT NOT NULL,
    message_text TEXT NOT NULL,
    sent_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    parent_message_id INT,
    FOREIGN KEY (event_id) REFERENCES Event(event_id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES User(user_id) ON DELETE CASCADE,
    FOREIGN KEY (parent_message_id) REFERENCES EventChatMessage(message_id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- HostRole tablosu (User'ın hangi eventlerde host olduğunu gösterir)
CREATE TABLE HostRole (
    user_id INT,
    event_id INT,
    role_type VARCHAR(50) DEFAULT 'host',
    assigned_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (user_id, event_id),
    FOREIGN KEY (user_id) REFERENCES User(user_id) ON DELETE CASCADE,
    FOREIGN KEY (event_id) REFERENCES Event(event_id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- Feedback tablosu
CREATE TABLE Feedback (
    feedback_id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT NOT NULL,
    event_id INT NOT NULL,
    type VARCHAR(50),
    title VARCHAR(255),
    message TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    status VARCHAR(50) DEFAULT 'pending',
    FOREIGN KEY (user_id) REFERENCES User(user_id) ON DELETE CASCADE,
    FOREIGN KEY (event_id) REFERENCES Event(event_id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- NOT: FeedbackFromUser ve FeedbackFromEvent tabloları gereksiz çünkü
-- Feedback tablosunda zaten user_id ve event_id foreign key'leri mevcut

-- İndeksler (Performans için)
CREATE INDEX idx_event_university ON Event(university_id);
CREATE INDEX idx_event_created_at ON Event(created_at);
CREATE INDEX idx_eventdate_event ON EventDate(event_id);
CREATE INDEX idx_user_email ON User(email);
CREATE INDEX idx_user_role ON User(role);
CREATE INDEX idx_chat_event ON EventChatMessage(event_id);
CREATE INDEX idx_chat_user ON EventChatMessage(user_id);
CREATE INDEX idx_chat_sent_at ON EventChatMessage(sent_at);
CREATE INDEX idx_attendance_event ON EventAttendance(event_id);
CREATE INDEX idx_attendance_status ON EventAttendance(status);
CREATE INDEX idx_favourite_user ON addEventToFavourite(user_id);
CREATE INDEX idx_feedback_event ON Feedback(event_id);
CREATE INDEX idx_feedback_user ON Feedback(user_id);

-- Örnek veriler ekleme
INSERT INTO University (name, short_name, website_url) VALUES
('İstanbul Teknik Üniversitesi', 'İTÜ', 'https://www.itu.edu.tr'),
('Boğaziçi Üniversitesi', 'BOÜN', 'https://www.boun.edu.tr'),
('Orta Doğu Teknik Üniversitesi', 'ODTÜ', 'https://www.metu.edu.tr');

-- View: Aktif eventleri ve katılımcı sayısını göster
CREATE VIEW ActiveEventsWithParticipants AS
SELECT 
    e.event_id,
    e.title,
    e.description,
    e.location,
    u.name AS university_name,
    COUNT(DISTINCT ea.user_id) AS participant_count,
    e.created_at
FROM Event e
LEFT JOIN University u ON e.university_id = u.university_id
LEFT JOIN EventAttendance ea ON e.event_id = ea.event_id
WHERE e.is_active = TRUE
GROUP BY e.event_id, e.title, e.description, e.location, u.name, e.created_at;

-- View: User profil bilgileri ile birlikte
CREATE VIEW UserFullProfile AS
SELECT 
    u.user_id,
    u.email,
    up.full_name,
    up.department,
    uni.name AS university_name,
    up.class_year,
    up.bio,
    u.created_at AS registration_date,
    u.last_login
FROM User u
LEFT JOIN UserProfile up ON u.user_id = up.user_id
LEFT JOIN University uni ON up.university_id = uni.university_id;
SHOW TABLES;
